<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="KubeVela Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="KubeVela Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5GLR1Y52M7"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-5GLR1Y52M7",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="KubeVela" href="/zh/opensearch.xml"><title data-react-helmet="true">使用 Jenkins + KubeVela 完成应用的持续交付 | KubeVela</title><meta data-react-helmet="true" property="og:title" content="使用 Jenkins + KubeVela 完成应用的持续交付 | KubeVela"><meta data-react-helmet="true" property="og:url" content="https://kubevela.io/zh/blog/2021/09/02/kubevela-jenkins-cicd"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:image" content="https://raw.githubusercontent.com/oam-dev/kubevela.io/main/docs/resources/KubeVela-03.png"><meta data-react-helmet="true" name="twitter:image" content="https://raw.githubusercontent.com/oam-dev/kubevela.io/main/docs/resources/KubeVela-03.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kubevela.io/zh/blog/2021/09/02/kubevela-jenkins-cicd"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/blog/2021/09/02/kubevela-jenkins-cicd" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/zh/blog/2021/09/02/kubevela-jenkins-cicd" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/blog/2021/09/02/kubevela-jenkins-cicd" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.1f84ae86.css">
<link rel="preload" href="/zh/assets/js/runtime~main.bd744588.js" as="script">
<link rel="preload" href="/zh/assets/js/main.b11ba324.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="KubeVela" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zh/img/logoDark.svg" alt="KubeVela" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KubeVela</strong></a><a class="navbar__item navbar__link" href="/zh/docs/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/zh/docs/">v1.1</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/">Next</a></li><li><a class="dropdown__link" href="/zh/docs/">v1.1</a></li><li><a class="dropdown__link" href="/zh/docs/v1.0/">v1.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>简体中文</span></span></a><ul class="dropdown__menu"><li><a href="/blog/2021/09/02/kubevela-jenkins-cicd" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/2021/09/02/kubevela-jenkins-cicd" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">简体中文</a></li></ul></div><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="KubeVela" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zh/img/logoDark.svg" alt="KubeVela" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KubeVela</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/zh/docs/next/">Next</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/">v1.1</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/v1.0/">v1.0</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/">文档</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/zh/blog">博客</a></li><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/blog/2021/09/02/kubevela-jenkins-cicd" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">English</a></li><li class="menu__list-item"><a href="/zh/blog/2021/09/02/kubevela-jenkins-cicd" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">简体中文</a></li></ul></li><li class="menu__list-item"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link"></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/2021/10/10/kubevela-gitops">基于 KubeVela 的 GitOps 交付</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/2021/10/08/blog-1.1">KubeVela 1.1 发布，开启混合环境应用持续交付新里程碑</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/zh/blog/2021/09/02/kubevela-jenkins-cicd">使用 Jenkins + KubeVela 完成应用的持续交付</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/2021/08/30/kubevela-performance-test">KubeVela Performance Test - Managing Massive Applications</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/2020/12/07/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes">KubeVela 正式开源：一个高可扩展的云原生应用平台与核心引擎</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">使用 Jenkins + KubeVela 完成应用的持续交付</h1><div class="margin-vert--md"><time datetime="2021-09-02T00:00:00.000Z" class="blogPostDate_fNvV">2021年9月2日 · 阅读需要 1 分钟</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="Da Yin, Yang Song"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Da Yin, Yang Song</a></h4><small class="avatar__subtitle">KubeVela 团队</small></div></div></header><div class="markdown"><p>KubeVela 打通了应用与基础设施之间的交付管控的壁垒，相较于原生的 Kubernetes 对象，KubeVela 的 Application 更好地简化抽象了开发者需要关心的配置，将复杂的基础设施能力及编排细节留给了平台工程师。而 KubeVela 的 apiserver 则是进一步为开发者提供了使用 HTTP Request 直接操纵 Application 的途径，使得开发者即使没有 Kubernetes 的使用经验与集群访问权限也可以轻松部署自己的应用。</p><p>本文就以经典的持续集成 (Continuous Integration) 工具 Jenkins 为基础，简单介绍如何打造基于 GitOps 的应用持续交付的“高速公路”。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="持续交付高速公路"></a>持续交付“高速公路”<a class="hash-link" href="#持续交付高速公路" title="Direct link to heading">#</a></h2><p>作为应用开发者的你，更多地关心自己的应用是否正常运作，开发流程是否便捷高效。为此，在这条持续交付的“高速公路”上，将会由以下部件为你保驾护航。</p><ol><li>你需要一个 git 仓库来存放应用程序代码、测试代码，以及描述 KubeVela Application 的 YAML 文件。</li><li>你需要一个持续集成 (Continuous Integration) 的工具帮你自动化完成程序代码的测试，并打包成镜像上传到仓库中。</li><li>你需要在 Kubernetes 集群上安装 KubeVela 并启用 apiserver 功能。</li></ol><blockquote><p>目前 KubeVela 的 apiserver 在权限认证方面仍待完善，后续启用 apiserver 后将会加入权限配置环节。</p></blockquote><p>本文的介绍中采用了 Github 作为 git 仓库，Jenkins 作为 CI 工具，DockerHub 作为镜像仓库。应用程序以一个简单的 HTTP Server 为例，整个持续交付的流程如下。可以看到，在这条持续交付的“高速公路”上，开发者只需要关心应用的开发并使用 Git 进行代码版本的维护，即可自动走完测试流程并部署应用到 Kubernetes 集群中。</p><p><img alt="arch" src="/zh/assets/images/arch-53b2b1a473f0d637d4c7c0b9a81dd2b0.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="部署环境"></a>部署环境<a class="hash-link" href="#部署环境" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="jenkins-环境"></a>Jenkins 环境<a class="hash-link" href="#jenkins-环境" title="Direct link to heading">#</a></h3><blockquote><p>本文采用了 Jenkins 作为持续集成工具，开发者也可以使用其他 CI 工具，如 TravisCI 或者 GitHub Action。</p></blockquote><p>首先你需要准备一份 Jenkins 环境来部署 CI 流水线。安装与初始化 Jenkins 流程可以参见<a href="https://www.jenkins.io/doc/book/installing/linux/" target="_blank" rel="noopener noreferrer">官方文档</a>。</p><p>需要注意的是，由于本文的 CI 流水线是基于 Docker 及 GitHub 的，因此在安装 Jenkins 之后还需要安装相关插件 (Dashboard &gt; Manage Jenkins &gt; Manage Plugins) ，包括 Pipeline、HTTP Request Plugin、Docker Pipeline、Docker Plugin。</p><p>此外，还需要为 Jenkins 配置 Docker 的运行环境 (Dashboard &gt; Manage Jenkins &gt; Configure System &gt; Docker Builder) ，如 Jenkins 所在环境已经安装了 Docker，可以将 Docker URL 配置为 <code>unix:///var/run/docker.sock</code>。</p><p>由于在 CI 流水线运行过程中，还需要将容器镜像推至镜像仓库，为此需在 Jenkins 的 Credential 中将镜像仓库的账户配置好 (Dashboard &gt; Manage Jenkins &gt; Manage Credentials &gt; Add Credentials) ，比如将 DockerHub 的用户名及密码存入。</p><p><img alt="jenkins-credential" src="/zh/assets/images/jenkins-credential-52c71b3f3a886ec0596a29a2356ad291.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="github-仓库环境"></a>GitHub 仓库环境<a class="hash-link" href="#github-仓库环境" title="Direct link to heading">#</a></h3><blockquote><p>本文的介绍采用了 Github 作为代码仓库，开发者还可以根据各自的需求与喜好，使用其他代码仓库，如 Gitlab。</p></blockquote><p>为使持续集成工具 Jenkins 能够获取到 GitHub 中的更新，并将流水线的运行状态反馈回 GitHub，需要在 GitHub 中完成以下两步操作。</p><ol><li><a href="https://github.com/settings/tokens/new" target="_blank" rel="noopener noreferrer">配置</a> Personal Access Token。注意将 <code>repo:status</code> 勾选，以获得向 GitHub 推送 Commit 状态的权限。</li></ol><p><img alt="github-pat" src="/zh/assets/images/github-pat-a8de5950eaf01a6d416a869d70b189ac.png"></p><p>然后在 Jenkins 的 Credential 中加入 Secret Text 类型的 Credential 并将上述的 GitHub 的 Personal Access Token 填入。</p><p><img alt="jenkins-secret-text" src="/zh/assets/images/jenkins-secret-text-0de6c324500b26a5bfb81520ff7eab2b.png"></p><p>最后来到 Jenkins 的 Dashboard &gt; Manage Jenkins &gt; Configure System &gt; GitHub 中点击 Add GitHub Server 并将刚才创建的 Credential 填入。完成后可以点击 Test connection 来验证配置是否正确。</p><p><img alt="jenkins-github" src="/zh/assets/images/jenkins-github-e99c47fab606f6c9c9f3f6f841840329.png"></p><ol start="2"><li>在 GitHub 的代码仓库的设定里添加 Webhook，将 Jenkins 的地址对应的 Webhook 地址填入，比如 <a href="http://my-jenkins.example.com/github-webhook/" target="_blank" rel="noopener noreferrer">http://my-jenkins.example.com/github-webhook/</a> 。这样，该代码仓库的所有 Push 事件推送到 Jenkins 中。</li></ol><p><img alt="github-webhook" src="/zh/assets/images/github-webhook-5579402b6bc37238d42842fd5d52fd02.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-环境"></a>KubeVela 环境<a class="hash-link" href="#kubevela-环境" title="Direct link to heading">#</a></h3><p>你需要在 Kubernetes 集群中安装 KubeVela，并启用 apiserver 功能，可以参考<a href="/zh/docs/platform-engineers/advanced-install#install-kubevela-with-apiserver">官方文档</a>。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="编写应用"></a>编写应用<a class="hash-link" href="#编写应用" title="Direct link to heading">#</a></h2><p>本文采用的应用是一个基于 Golang 语言编写的简单的 HTTP Server。在代码中，声明了一个名叫 <code>VERSION</code> 的常量，并在访问该服务时打印出来。同时还附带一个简单的测试，用来校验 <code>VERSION</code> 的格式是否符合标准。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// main.go</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> main</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;fmt&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;net/http&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> VERSION </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.1.0-v1alpha1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">main</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HandleFunc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r </span><span class="token operator">*</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fprintf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Version: %s\n&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ListenAndServe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;:8088&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">println</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// main_test.go</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> main</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;regexp&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;testing&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> verRegex </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">`^v?([0-9]+)(\.[0-9]+)?(\.[0-9]+)?`</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">`(-([0-9A-Za-z\-]+(\.[0-9A-Za-z\-]+)*))?`</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">`(\+([0-9A-Za-z\-]+(\.[0-9A-Za-z\-]+)*))?$`</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">TestVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t </span><span class="token operator">*</span><span class="token plain">testing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">T</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> ok</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> regexp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">MatchString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">verRegex</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">ok </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fatalf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;invalid version: %s&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在应用交付时需要将 Golang 服务打包成镜像并以 KubeVela Application 的形式发布到 Kubernetes 集群中，因此在代码仓库中还包含 <code>Dockerfile</code> 以及 <code>app.yaml</code> 文件，分别用来描述镜像的打包方式以及 Application 的相关配置。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Dockerfile"><div tabindex="0" class="prism-code language-Dockerfile codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain"># Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">FROM golang:1.13-rc-alpine3.10 as builder</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">COPY main.go .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">RUN go build -o kubevela-demo-cicd-app main.go</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">FROM alpine:3.10</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">COPY --from=builder /app/kubevela-demo-cicd-app /app/kubevela-demo-cicd-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ENTRYPOINT ./kubevela-demo-cicd-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">EXPOSE 8088</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在 app.yaml 中，声明了部署的应用包含 5 个不同副本，同时通过 Ingress 的形式发布给集群外部。而 labels 则是给应用中的 Pod 打上了当前的 git commit 作为标签。当 Jenkins 的部署流水线运行时，会将 GIT_COMMIT 注入其中，提交到 KubeVela apiserver，从而触发 Application 的更新。在版本更新过程中，按照 2, 3 的数量分两次次更新副本，同时在第一次更新后停止自动更新，等待手动确认后再进行全部更新，实现金丝雀发布的过程。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># app.yaml</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">web</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> somefive/kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cicd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Always</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">traits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> rollout</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rolloutBatches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">batchPartition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">targetSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> labels</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">jenkins-build-commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ingress</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cicd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app.cf7c0ed25b151437ebe1ef58efc29bca4.us</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">west</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">1.alicontainer.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8088</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="配置-ci-流水线"></a>配置 CI 流水线<a class="hash-link" href="#配置-ci-流水线" title="Direct link to heading">#</a></h2><p>在本文的案例中，包含两条流水线，一条是用来进行测试的流水线 (对应用代码运行测试) ，一条是交付流水线 (将应用代码打包上传镜像仓库，同时更新目标环境中的应用，实现自动更新) 。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="测试流水线"></a>测试流水线<a class="hash-link" href="#测试流水线" title="Direct link to heading">#</a></h3><p>在 Jenkins 中创建一条新的 Pipeline，并配置 Build Triggers 为 GitHub hook trigger for GITScm polling。</p><p><img alt="test-pipeline-create" src="/zh/assets/images/test-pipeline-create-34edf7a7b95307cec884803ca545c2e3.png">
<img alt="test-pipeline-config" src="/zh/assets/images/test-pipeline-config-3ae2830ca7d45dbe9579a7814d96abc0.png"></p><p>在这条流水线中，首先是采用了 golang 的镜像作为执行环境，方便后续运行测试。然后将分支配置为 GitHub 仓库中的 dev 分支，代表该条流水线被 Push 事件触发后会拉取 dev 分支上的内容并执行测试。测试结束后将流水线的状态回写至 GitHub 中。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly groovy"><div tabindex="0" class="prism-code language-groovy codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">void setBuildStatus(String message, String state) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  step([</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      $class: &quot;GitHubCommitStatusSetter&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      reposSource: [$class: &quot;ManuallyEnteredRepositorySource&quot;, url: &quot;https://github.com/Somefive/KubeVela-demo-CICD-app&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      contextSource: [$class: &quot;ManuallyEnteredCommitContextSource&quot;, context: &quot;ci/jenkins/test-status&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      errorHandlers: [[$class: &quot;ChangingBuildStatusErrorHandler&quot;, result: &quot;UNSTABLE&quot;]],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      statusResultSource: [ $class: &quot;ConditionalStatusResultSource&quot;, results: [[$class: &quot;AnyBuildResult&quot;, message: message, state: state]] ]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ]);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">pipeline {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    agent {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        docker { image &#x27;golang:1.13-rc-alpine3.10&#x27; }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    stages {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Prepare&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def checkout = git branch: &#x27;dev&#x27;, url: &#x27;https://github.com/Somefive/KubeVela-demo-CICD-app.git&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_COMMIT = checkout.GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_BRANCH = checkout.GIT_BRANCH</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;env.GIT_BRANCH=${env.GIT_BRANCH},env.GIT_COMMIT=${env.GIT_COMMIT}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                setBuildStatus(&quot;Test running&quot;, &quot;PENDING&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Test&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;CGO_ENABLED=0 GOCACHE=$(pwd)/.cache go test *.go&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    post {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        success {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Test success&quot;, &quot;SUCCESS&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        failure {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Test failed&quot;, &quot;FAILURE&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="部署流水线"></a>部署流水线<a class="hash-link" href="#部署流水线" title="Direct link to heading">#</a></h3><p>在部署流水线中，类似测试流水线，首先将代码仓库中的分支拉取下来，区别是这里采用 prod 分支。然后使用 Docker 进行镜像构建并推送至远端镜像仓库 (这里为 DockerHub，其中 withRegistry 中填写镜像仓库位置以及在先前步骤中存入的 DockerHub 的账户对应的 Credential 的 ID) 。构建成功后，再将 Application 对应的 YAML 文件转换为 JSON 文件并注入 GIT_COMMIT，最后向 KubeVela apiserver (此处为 <a href="http://47.88.24.19/" target="_blank" rel="noopener noreferrer">http://47.88.24.19/</a>) 发送请求进行创建或更新。</p><blockquote><p>目前的 KubeVela apiserver 接收 JSON 参数，因此在流水线中做了相应的转换。未来的 KubeVela apiserver 将会进一步改进交互模式，简化此处的流程，同时再加上更为严格的权限认证，提高安全性。</p></blockquote><blockquote><p>该案例中会向 kubevela-demo-namespace 这个 Namespace 中创建名叫 cicd-demo-app 的应用，注意这个 Namespace 需要预先在 Kubernetes 中创建出来。未来 KubeVela 的 apiserver 同样会简化这一流程。</p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly groovy"><div tabindex="0" class="prism-code language-groovy codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">void setBuildStatus(String message, String state) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  step([</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      $class: &quot;GitHubCommitStatusSetter&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      reposSource: [$class: &quot;ManuallyEnteredRepositorySource&quot;, url: &quot;https://github.com/Somefive/KubeVela-demo-CICD-app&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      contextSource: [$class: &quot;ManuallyEnteredCommitContextSource&quot;, context: &quot;ci/jenkins/deploy-status&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      errorHandlers: [[$class: &quot;ChangingBuildStatusErrorHandler&quot;, result: &quot;UNSTABLE&quot;]],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      statusResultSource: [ $class: &quot;ConditionalStatusResultSource&quot;, results: [[$class: &quot;AnyBuildResult&quot;, message: message, state: state]] ]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ]);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">pipeline {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    agent any</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    stages {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Prepare&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def checkout = git branch: &#x27;prod&#x27;, url: &#x27;https://github.com/Somefive/KubeVela-demo-CICD-app.git&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_COMMIT = checkout.GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_BRANCH = checkout.GIT_BRANCH</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;env.GIT_BRANCH=${env.GIT_BRANCH},env.GIT_COMMIT=${env.GIT_COMMIT}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    setBuildStatus(&quot;Deploy running&quot;, &quot;PENDING&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Build&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    docker.withRegistry(&quot;https://registry.hub.docker.com&quot;, &quot;DockerHubCredential&quot;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        def customImage = docker.build(&quot;somefive/kubevela-demo-cicd-app&quot;)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        customImage.push()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Deploy&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;wget -q &quot;https://github.com/mikefarah/yq/releases/download/v4.12.1/yq_linux_amd64&quot;&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;chmod +x yq_linux_amd64&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def app = sh (</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        script: &quot;./yq_linux_amd64 eval -o=json &#x27;.spec&#x27; app.yaml | sed -e &#x27;s/GIT_COMMIT/$GIT_COMMIT/g&#x27;&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        returnStdout: true</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    )</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;app: ${app}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def response = httpRequest acceptType: &#x27;APPLICATION_JSON&#x27;, contentType: &#x27;APPLICATION_JSON&#x27;, httpMode: &#x27;POST&#x27;, requestBody: app, url: &quot;http://47.88.24.19/v1/namespaces/kubevela-demo-namespace/applications/cicd-demo-app&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    println(&#x27;Status: &#x27;+response.status)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    println(&#x27;Response: &#x27;+response.content)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    post {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        success {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Deploy success&quot;, &quot;SUCCESS&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        failure {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Deploy failed&quot;, &quot;FAILURE&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="实际表现"></a>实际表现<a class="hash-link" href="#实际表现" title="Direct link to heading">#</a></h2><p>在完成上述的配置流程后，持续交付的流程便已经搭建完成。我们可以来检验一下它的效果。</p><p><img alt="pipeline-overview" src="/zh/assets/images/pipeline-overview-36827d3925d667b9d14612cb59e8fb4e.png"></p><p>我们首先将 <code>main.go</code> 中的 <code>VERSION</code> 字段修改为 <code>Bad Version Number</code>，即</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> VERSION </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Bad Version Number&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>然后提交该修改至 dev 分支。我们可以看到 Jenkins 上的测试流水线被触发运行，失败后将该状态回写给 GitHub。</p><p><img alt="test-pipeline-fail" src="/zh/assets/images/test-pipeline-fail-23682b9d0c60a43f26be0a5a98e8a413.png">
<img alt="test-github-fail" src="/zh/assets/images/test-github-fail-5dd21696c58a212cf6ca2ee80e56567e.png"></p><p>我们重新将 <code>VERSION</code> 修改为 0.1.1，然后再次提交。可以看到这一次测试流水线成功完成执行，并在 GitHub 对应的 Commit 上看到了成功的标志。</p><p><img alt="test-pipeline-success" src="/zh/assets/images/test-pipeline-success-cd84def7976efb35b5071c9e361d2a77.png">
<img alt="test-github-success" src="/zh/assets/images/test-github-success-1d9c59d67bfd9b24d8b455fa21c6d985.png"></p><p>接下来我们在 GitHub 上提交 Pull Request 尝试将 dev 分支上的更新合并至 prod 分支上。</p><p><img alt="pull-request" src="/zh/assets/images/pull-request-eca7ff259bb26a6661d79691728b0b31.png"></p><p>可以看到在 Jenkins 的部署流水线成功运行结束后，GitHub 上 prod 分支最新的 Commit 也显示了成功的标志。</p><p><img alt="deploy-pipeline-success" src="/zh/assets/images/deploy-pipeline-success-7890c92b41e666ef46f3bd2dc1975ee7.png">
<img alt="deploy-github-success" src="/zh/assets/images/deploy-github-success-07f305b1b587e3fa8acc5df68fd8c297.png"></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get app -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                     COMPONENT               TYPE         PHASE     HEALTHY   STATUS   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-cicd-app   kubevela-demo-app-web   webservice   running   </span><span class="token boolean">true</span><span class="token plain">               112s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           2m1s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>如图显示，要部署的应用顺利被 KubeVela apiserver 接受并由 KubeVela 控制器创建了相关资源。当前 Deployment 的副本数是 2，在删除了该 Application 中 rollout 特征内的 <code>batchPartition: 0</code> 后代表确认了当前的发布，然后对应的 Deployment 副本数更新至 5。这时我们可以访问 Ingress 所配置的域名，成功显示了当前的版本号。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl edit app -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">application.core.oam.dev/kubevela-demo-cicd-app edited</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">4</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">4</span><span class="token plain">           3m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m40s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m40s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>我们重复以上步骤，将版本升级至 0.1.2，完成测试流水线及部署流水线。接着我们会发现 Kubernetes 的集群内对应的 Application 控制的 Deployment 发生了版本更替，旧版本的 Deployment 从 5 副本下降到 3 副本，新版本的 Deployment 则出现了 2 副本。如果此时我们再访问原来的服务地址，会发现有时会显示 0.1.1 版本，有时会显示 0.1.2 版本。这是因为在当前滚动更新过程中，新旧副本同时存在，访问的流量会被负载均衡器分发到不同的副本上，因此会出现两种版本的服务同时存在的现象。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           11m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           12m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           12m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">1</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">1</span><span class="token plain">           2s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           2s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/3     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           13m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/3     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           13m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/3     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           13m</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>当我们确认新版本的服务正常运作后，可以类似上述步骤，将 Application 中 rollout 特性内的 <code>batchPartition: 0</code> 删去，完成整个金丝雀发布流程。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/3     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m24s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m36s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">3</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           5m38s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">4</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">4</span><span class="token plain">           5m38s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/0     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/0     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m41s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m41s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="小结"></a>小结<a class="hash-link" href="#小结" title="Direct link to heading">#</a></h2><p>至此，我们便已经成功实现了一整套持续交付流程。在这个流程中，应用的开发者借助 KubeVela + Jenkins 的能力，可以轻松完成应用的迭代更新、集成测试、自动发布与滚动升级，而整个流程在各个环节也可以按照开发者的喜好和条件选择不同的工具，比如使用 Gitlab 替代 GitHub，或是使用 TravisCI 替代 Jenkins。</p><p>在上述过程中，细心的读者可能还会发现，这套流程不仅能够实现应用服务的升级，而且还可以通过修改 app.yaml 自动完成部署方案的升级，比如将 5 副本应用扩容到 10 副本，或是为容器添加 sidecar，从而实现部分 GitOps 能力。关于使用 KubeVela 实践 GitOps 的更多内容，感兴趣的读者可以继续阅读相关案例。</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/zh/blog/tags/kubevela">kubevela</a></div></footer></article><div><a href="https://github.com/oam-dev/kubevela.io/tree/main/blog/2021-09-02-kubevela-jenkins-cicd.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑本页</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog/2021/10/08/blog-1.1"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« KubeVela 1.1 发布，开启混合环境应用持续交付新里程碑</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/blog/2021/08/30/kubevela-performance-test"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">KubeVela Performance Test - Managing Massive Applications »</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#持续交付高速公路" class="table-of-contents__link">持续交付“高速公路”</a></li><li><a href="#部署环境" class="table-of-contents__link">部署环境</a><ul><li><a href="#jenkins-环境" class="table-of-contents__link">Jenkins 环境</a></li><li><a href="#github-仓库环境" class="table-of-contents__link">GitHub 仓库环境</a></li><li><a href="#kubevela-环境" class="table-of-contents__link">KubeVela 环境</a></li></ul></li><li><a href="#编写应用" class="table-of-contents__link">编写应用</a></li><li><a href="#配置-ci-流水线" class="table-of-contents__link">配置 CI 流水线</a><ul><li><a href="#测试流水线" class="table-of-contents__link">测试流水线</a></li><li><a href="#部署流水线" class="table-of-contents__link">部署流水线</a></li></ul></li><li><a href="#实际表现" class="table-of-contents__link">实际表现</a></li><li><a href="#小结" class="table-of-contents__link">小结</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">文档</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/quick-start">快速开始</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/case-studies/jenkins-cicd">最佳实践</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/platform-engineers/oam/oam-model">自定义扩展</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">社区</h4><ul class="footer__items"><li class="footer__item"><a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Slack ( #kubevela channel )</a></li><li class="footer__item"><a href="https://gitter.im/oam-dev/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog/2021/09/02/">钉钉 (23310022)</a></li><li class="footer__item"><div class="wechat"> <a class="wechat-label">Wechat Group(Scan code to request joining)</a> <a class="wechat-img" rel="noreferrer noopener" aria-label="Wechat Group"><img src="https://static.kubevela.net/images/barnett-wechat.jpg" alt="Broker wechat to add you into the user group."></a></div></li></ul></div><div class="col footer__col"><h4 class="footer__title">更多</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog">博客</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>© KubeVela Authors 2021 | Documentation Distributed under <a herf="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a> </strong> <strong>| Powered by <a href="https://www.netlify.com">Netlify</a></strong>
        <br>
      </div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.bd744588.js"></script>
<script src="/zh/assets/js/main.b11ba324.js"></script>
</body>
</html>