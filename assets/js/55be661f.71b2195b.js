(self.webpackChunkkubevela_io=self.webpackChunkkubevela_io||[]).push([[13670],{3905:function(e,n,t){"use strict";t.d(n,{Zo:function(){return c},kt:function(){return m}});var i=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)t=r[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)t=r[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=i.createContext({}),p=function(e){var n=i.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},c=function(e){var n=p(e.components);return i.createElement(s.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},d=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(t),m=a,h=d["".concat(s,".").concat(m)]||d[m]||u[m]||r;return t?i.createElement(h,o(o({ref:n},c),{},{components:t})):i.createElement(h,o({ref:n},c))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=t.length,o=new Array(r);o[0]=d;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var p=2;p<r;p++)o[p]=t[p];return i.createElement.apply(null,o)}return i.createElement.apply(null,t)}d.displayName="MDXCreateElement"},26594:function(e,n,t){"use strict";t.r(n),t.d(n,{frontMatter:function(){return o},metadata:function(){return l},toc:function(){return s},default:function(){return c}});var i=t(22122),a=t(19756),r=(t(67294),t(3905)),o={title:"Jenkins CI/CD"},l={unversionedId:"case-studies/jenkins-cicd",id:"case-studies/jenkins-cicd",isDocsHomePage:!1,title:"Jenkins CI/CD",description:"This section will introduce how to use KubeVela with existing CI/CD tools such as Jenkins and why.",source:"@site/docs/case-studies/jenkins-cicd.md",sourceDirName:"case-studies",slug:"/case-studies/jenkins-cicd",permalink:"/docs/next/case-studies/jenkins-cicd",editUrl:"https://github.com/oam-dev/kubevela.io/edit/main/docs/case-studies/jenkins-cicd.md",version:"current",lastUpdatedBy:"Lei Zhang (Harry)",lastUpdatedAt:1631669180,formattedLastUpdatedAt:"9/15/2021",frontMatter:{title:"Jenkins CI/CD"},sidebar:"docs",previous:{title:"Deploy Kubernetes Raw Resource",permalink:"/docs/next/deliver-app/k8s-object"},next:{title:"GitOps with KubeVela",permalink:"/docs/next/case-studies/gitops"}},s=[{value:"Introduction",id:"introduction",children:[]},{value:"Preparation",id:"preparation",children:[]},{value:"Combining Jenkins with KubeVela apiserver",id:"combining-jenkins-with-kubevela-apiserver",children:[]},{value:"More",id:"more",children:[]}],p={toc:s};function c(e){var n=e.components,t=(0,a.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,i.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This section will introduce how to use KubeVela with existing CI/CD tools such as Jenkins and why."),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"With a simple integration effort, KubeVela as a universal application delivery control plane can then supercharge existing CI/CD tools with modern application deployment capabilities such as:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hybrid/multi-cloud delivery;"),(0,r.kt)("li",{parentName:"ul"},"cross-environments promotion;"),(0,r.kt)("li",{parentName:"ul"},"service mesh based application rollout/rollback;"),(0,r.kt)("li",{parentName:"ul"},"handling deployment dependencies and topology (DAG);"),(0,r.kt)("li",{parentName:"ul"},"declare, provision and consume cloud resources alongside with your application;"),(0,r.kt)("li",{parentName:"ul"},"enjoy benefits of ",(0,r.kt)("a",{parentName:"li",href:"https://www.weave.works/blog/what-is-gitops-really"},"GitOps")," delivery without the need to introduce full GitOps transformation to your team;"),(0,r.kt)("li",{parentName:"ul"},"... and much more.")),(0,r.kt)("p",null,"The following guide will use Jenkins as an example to release a sample HTTP server application step by step. The application code can be found in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Somefive/KubeVela-demo-CICD-app"},"this GitHub repo"),"."),(0,r.kt)("h2",{id:"preparation"},"Preparation"),(0,r.kt)("p",null,"Before combining KubeVela and Jenkins, you need to ensure the following environments have already been set up."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Deploy Jenkins service with Docker support, including related plugins and credentials which will be used to access image repository."),(0,r.kt)("li",{parentName:"ol"},"A git repository with Webhook enabled. Ensure commits to the target branch will trigger the running of the Jenkins pipeline."),(0,r.kt)("li",{parentName:"ol"},"Get Kubernetes for deployment. Install KubeVela and enable its apiserver. Ensure the KubeVela apiserver can be accessed from external environment.")),(0,r.kt)("h2",{id:"combining-jenkins-with-kubevela-apiserver"},"Combining Jenkins with KubeVela apiserver"),(0,r.kt)("p",null,"Deploy Jenkins pipeline with the following Groovy script. You can change the git repository address, image address, apiserver address and other environment configurations on demand. Your git repository should contain the ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"app.yaml")," configuration file to tell how to build the target image and which component the application contains."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-groovy"},"pipeline {\n    agent any\n    environment {\n        GIT_BRANCH = 'prod'\n        GIT_URL = 'https://github.com/Somefive/KubeVela-demo-CICD-app.git'\n        DOCKER_REGISTRY = 'https://registry.hub.docker.com'\n        DOCKER_CREDENTIAL = 'DockerHubCredential'\n        DOCKER_IMAGE = 'somefive/kubevela-demo-cicd-app'\n        APISERVER_URL = 'http://47.88.24.19'\n        APPLICATION_YAML = 'app.yaml'\n        APPLICATION_NAMESPACE = 'kubevela-demo-namespace'\n        APPLICATION_NAME = 'cicd-demo-app'\n    }\n    stages {\n        stage('Prepare') {\n            steps {\n                script {\n                    def checkout = git branch: env.GIT_BRANCH, url: env.GIT_URL\n                    env.GIT_COMMIT = checkout.GIT_COMMIT\n                    env.GIT_BRANCH = checkout.GIT_BRANCH\n                    echo \"env.GIT_BRANCH=${env.GIT_BRANCH},env.GIT_COMMIT=${env.GIT_COMMIT}\"\n                }\n            }\n        }\n        stage('Build') {\n            steps {\n                script {\n                    docker.withRegistry(env.DOCKER_REGISTRY, env.DOCKER_CREDENTIAL) {\n                        def customImage = docker.build(env.DOCKER_IMAGE)\n                        customImage.push()\n                    }\n                }\n            }\n        }\n        stage('Deploy') {\n            steps {\n                sh 'wget -q \"https://github.com/mikefarah/yq/releases/download/v4.12.1/yq_linux_amd64\"'\n                sh 'chmod +x yq_linux_amd64'\n                script {\n                    def app = sh (\n                        script: \"./yq_linux_amd64 eval -o=json '.spec' ${env.APPLICATION_YAML} | sed -e 's/GIT_COMMIT/$GIT_COMMIT/g'\",\n                        returnStdout: true\n                    )\n                    echo \"app: ${app}\"\n                    def response = httpRequest acceptType: 'APPLICATION_JSON', contentType: 'APPLICATION_JSON', httpMode: 'POST', requestBody: app, url: \"${env.APISERVER_URL}/v1/namespaces/${env.APPLICATION_NAMESPACE}/applications/${env.APPLICATION_NAME}\"\n                    println('Status: '+response.status)\n                    println('Response: '+response.content)\n                }\n            }\n        }\n    }\n}\n")),(0,r.kt)("p",null,"Push commits to the target branch in the git repository, which the Jenkins pipeline focuses on. The webhook of git repo will trigger the newly created Jenkins pipeline. This pipeline will automatically build container images and push it to the image repository. Then it will send POST request to KubeVela apiserver, which will deploy ",(0,r.kt)("inlineCode",{parentName:"p"},"app.yaml")," to Kubernetes cluster. An example of ",(0,r.kt)("inlineCode",{parentName:"p"},"app.yaml")," is shown below."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: core.oam.dev/v1beta1\nkind: Application\nmetadata:\n  name: kubevela-demo-app\nspec:\n  components:\n    - name: kubevela-demo-app-web\n      type: webservice\n      properties:\n        image: somefive/kubevela-demo-cicd-app\n        imagePullPolicy: Always\n        port: 8080\n      traits:\n        - type: rollout\n          properties:\n            rolloutBatches:\n              - replicas: 2\n              - replicas: 3\n            batchPartition: 0\n            targetSize: 5\n        - type: labels\n          properties:\n            jenkins-build-commit: GIT_COMMIT\n        - type: ingress\n          properties:\n            domain: <your domain>\n            http:\n              "/": 8088\n')),(0,r.kt)("p",null,"THe ",(0,r.kt)("em",{parentName:"p"},"GIT_COMMIT")," identifier will be replaced by the current git commit id in Jenkins pipeline. You can check the deployment status in Kubernetes through ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl get app -n kubevela-demo-namespace   \nNAME            COMPONENT               TYPE         PHASE     HEALTHY   STATUS   AGE\ncicd-demo-app   kubevela-demo-app-web   webservice   running   true               102s\n$ kubectl get deployment -n kubevela-demo-namespace\nNAME                       READY   UP-TO-DATE   AVAILABLE   AGE\nkubevela-demo-app-web-v1   2/2     2            2           111s\n$ kubectl get ingress -n kubevela-demo-namespace \nNAME                    CLASS    HOSTS                                                                                 ADDRESS          PORTS   AGE\nkubevela-demo-app-web   <none>   <your domain>   198.11.175.125   80      117s\n")),(0,r.kt)("p",null,"In the deployed application, we use the ",(0,r.kt)("inlineCode",{parentName:"p"},"rollout")," trait, which enables us to release 2 pods first for canary validation. After validation succeed, remove ",(0,r.kt)("inlineCode",{parentName:"p"},"batchPatition: 0")," in application configuration in the ",(0,r.kt)("inlineCode",{parentName:"p"},"rollout")," trait. After that, a complete release will be fired. This mechanism greatly improves the security and stability of the releasing process. You can adjust the rollout strategy depending on your scenario."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl edit app -n kubevela-demo-namespace   \napplication.core.oam.dev/cicd-demo-app edited\n$ kubectl get deployment -n kubevela-demo-namespace\nNAME                       READY   UP-TO-DATE   AVAILABLE   AGE\nkubevela-demo-app-web-v1   5/5     5            5           4m16s\n$ curl http://<your domain>/\nVersion: 0.1.2\n")),(0,r.kt)("h2",{id:"more"},"More"),(0,r.kt)("p",null,"Refer to the ",(0,r.kt)("a",{parentName:"p",href:"/blog/2021/09/02/kubevela-jenkins-cicd"},"blog post")," for more details about deploying Jenkins + KubeVela and more comprehensive demo for application rolling update."))}c.isMDXComponent=!0}}]);